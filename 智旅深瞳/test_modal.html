<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试模态框关闭功能</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>测试模态框关闭功能</h1>
    <p>点击下面的按钮测试模态框关闭功能：</p>
    
    <button id="testBtn1">测试模态框1</button>
    <button id="testBtn2">测试模态框2</button>
    <button id="testBtn3">测试嵌套模态框</button>
    
    <div id="log" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px; height: 200px; overflow-y: auto;"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function closeModal(button) {
            log('closeModal函数被调用，参数：' + (button ? '有效按钮' : 'null'));
            
            // 如果传入的是null或undefined，尝试找到最后一个模态框
            if (!button) {
                log('参数为null，尝试找到最后一个模态框');
                const modals = document.querySelectorAll('div[style*="position: fixed"]');
                if (modals.length > 0) {
                    log('找到 ' + modals.length + ' 个模态框，移除最后一个');
                    modals[modals.length - 1].remove();
                } else {
                    log('没有找到任何模态框');
                }
                return;
            }
            
            // 尝试通过按钮找到父级模态框
            let modal = button.closest('div[style*="position: fixed"]');
            
            // 如果找不到，尝试通过其他方式找到模态框
            if (!modal) {
                log('通过closest方法未找到模态框，尝试其他方法');
                // 尝试找到按钮的父级元素，直到找到模态框
                let parent = button.parentElement;
                while (parent && parent !== document.body) {
                    if (parent.style && parent.style.position === 'fixed') {
                        modal = parent;
                        break;
                    }
                    parent = parent.parentElement;
                }
                
                // 如果还是找不到，尝试找到最后一个模态框
                if (!modal) {
                    log('通过遍历父级元素未找到模态框，尝试找到最后一个模态框');
                    const modals = document.querySelectorAll('div[style*="position: fixed"]');
                    if (modals.length > 0) {
                        modal = modals[modals.length - 1];
                    }
                }
            }
            
            // 移除模态框
            if (modal) {
                log('找到模态框，正在移除');
                modal.remove();
            } else {
                log('未找到任何模态框');
            }
        }

        function createModal(title, content, hasCloseButton = true) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div class="modal-content">
                    ${hasCloseButton ? '<button class="close-btn" id="closeBtn">&times;</button>' : ''}
                    <h2>${title}</h2>
                    <p>${content}</p>
                    <button id="testNullBtn">测试closeModal(null)</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 为关闭按钮添加事件监听器
            if (hasCloseButton) {
                const closeBtn = document.getElementById('closeBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        closeModal(this);
                    });
                }
            }
            
            // 为测试null按钮添加事件监听器
            const testNullBtn = document.getElementById('testNullBtn');
            if (testNullBtn) {
                testNullBtn.addEventListener('click', function() {
                    closeModal(null);
                });
            }
        }

        // 为测试按钮添加事件监听器
        document.getElementById('testBtn1').addEventListener('click', function() {
            createModal('测试模态框1', '这是一个测试模态框，点击右上角的×按钮或下面的按钮测试关闭功能。');
        });

        document.getElementById('testBtn2').addEventListener('click', function() {
            createModal('测试模态框2', '这是另一个测试模态框，用于测试多个模态框的关闭功能。');
        });

        document.getElementById('testBtn3').addEventListener('click', function() {
            createModal('嵌套模态框测试', '点击下面的按钮创建另一个模态框');
            
            // 添加一个创建嵌套模态框的按钮
            setTimeout(() => {
                const modalContent = document.querySelector('.modal-content');
                if (modalContent) {
                    const nestedBtn = document.createElement('button');
                    nestedBtn.textContent = '创建嵌套模态框';
                    nestedBtn.style.margin = '10px 5px 0 0';
                    modalContent.appendChild(nestedBtn);
                    
                    nestedBtn.addEventListener('click', function() {
                        createModal('嵌套模态框', '这是一个嵌套模态框，测试嵌套模态框的关闭功能');
                    });
                }
            }, 100);
        });
    </script>
</body>
</html>